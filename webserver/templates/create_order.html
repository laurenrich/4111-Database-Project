{% extends "base.html" %}

{% block content %}
  <h1>Create Order for {{ restaurant.name }}</h1>
  <p><a href="/restaurants/{{ restaurant.id }}">‚Üê Back to Restaurant</a></p>
  
  <p><strong>Logged in as:</strong> {{ current_user.username if current_user else (session.username if session.username else 'Guest') }} ({{ session.role if session.role else 'N/A' }})</p>
  
  <form method="POST" id="orderForm">
    <h2>Select Dishes</h2>
    {% if dishes|length == 0 %}
      <p>No dishes available for this restaurant.</p>
    {% else %}
      <table>
        <tr>
          <th>Dish</th>
          <th>Price (per item)</th>
          <th>Quantity</th>
        </tr>
        {% for dish in dishes %}
        <tr>
          <td>{{ dish.name }}</td>
          <td>
            {% if dish.price %}
              ${{ "%.2f"|format(dish.price) }}
            {% else %}
              <span style="color: #999;">Price not set</span>
            {% endif %}
            <input type="hidden" name="price_{{ dish.id }}" value="{{ dish.price if dish.price else '0.00' }}">
          </td>
          <td>
            <input type="number" name="quantity[]" min="0" value="0" 
                   onchange="updateTotal()">
            <input type="hidden" name="dish_id[]" value="{{ dish.id }}">
          </td>
        </tr>
        {% endfor %}
      </table>
      
      <div style="margin-top: 20px; font-size: 18px; font-weight: bold;">
        <span>Estimated Total: $<span id="totalPrice">0.00</span></span>
      </div>
    {% endif %}
    
    <div>
      <button type="submit">Create Order</button>
    </div>
  </form>
  
  <script>
    function updateTotal() {
      var total = 0;
      var rows = document.querySelectorAll('table tr');
      
      for (var i = 1; i < rows.length; i++) {
        var row = rows[i];
        var quantityInput = row.querySelector('input[name="quantity[]"]');
        var priceInput = row.querySelector('input[name^="price_"]');
        
        if (quantityInput && priceInput) {
          var quantity = parseInt(quantityInput.value) || 0;
          var price = parseFloat(priceInput.value) || 0;
          total += quantity * price;
        }
      }
      
      document.getElementById('totalPrice').textContent = total.toFixed(2);
    }
    
    // Add event listeners to all quantity inputs
    document.addEventListener('DOMContentLoaded', function() {
      var quantityInputs = document.querySelectorAll('input[name="quantity[]"]');
      quantityInputs.forEach(function(input) {
        input.addEventListener('input', updateTotal);
        input.addEventListener('change', updateTotal);
      });
    });
  </script>
{% endblock %}

